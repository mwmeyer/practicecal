<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üóìÔ∏èPracticeCal</title>

        <!-- React -->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.development.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                color: #1d1d1f;
                background: #fbfbfd;
                line-height: 1.4;
            }

            .app {
                max-width: 800px;
                margin: 0 auto;
                padding: 40px 20px;
            }

            .header {
                text-align: center;
                margin-bottom: 60px;
            }

            .title {
                font-size: 32px;
                font-weight: 600;
                letter-spacing: -0.02em;
                margin-bottom: 8px;
            }

            .week-nav {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 24px;
                margin-bottom: 40px;
            }

            .week-title {
                font-size: 17px;
                font-weight: 500;
                color: #6e6e73;
                min-width: 200px;
            }

            .nav-button {
                background: none;
                border: none;
                font-size: 24px;
                color: #0066cc;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .nav-button:hover {
                background: #f2f2f7;
            }

            .total-practice {
                text-align: center;
                padding: 40px 20px;
                margin-top: 40px;
                border-top: 1px solid #d2d2d7;
            }

            .total-label {
                font-size: 14px;
                color: #6e6e73;
                margin-bottom: 8px;
                font-weight: 500;
            }

            .total-time {
                font-size: 48px;
                font-weight: 200;
                color: #1d1d1f;
                letter-spacing: -0.02em;
                margin-bottom: 4px;
            }

            .total-subtitle {
                font-size: 16px;
                color: #6e6e73;
            }

            .calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                background: #d2d2d7;
                border-radius: 12px;
                overflow: hidden;
                margin-bottom: 40px;
            }

            .day-header {
                background: white;
                padding: 16px 8px;
                text-align: center;
                font-size: 14px;
                font-weight: 500;
                color: #6e6e73;
            }

            .day-cell {
                background: white;
                min-height: 100px;
                padding: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            }

            .day-cell:hover {
                background: #f2f2f7;
            }

            .day-cell.has-practice {
                background: #e8f4fd;
            }

            .day-cell.today {
                background: #fff3cd;
            }

            .day-date {
                font-size: 14px;
                color: #6e6e73;
                margin-bottom: 8px;
            }

            .day-total {
                font-size: 16px;
                font-weight: 600;
                color: #0066cc;
                margin-bottom: 8px;
            }

            .session {
                font-size: 12px;
                color: #6e6e73;
                margin-bottom: 4px;
                padding: 4px 6px;
                background: rgba(0, 102, 204, 0.1);
                border-radius: 4px;
            }

            .week-total {
                text-align: center;
                font-size: 24px;
                font-weight: 600;
                color: #0066cc;
                margin-bottom: 40px;
            }

            .modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal-content {
                background: white;
                border-radius: 12px;
                padding: 32px;
                width: 90%;
                max-width: 400px;
            }

            .modal-title {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 24px;
                text-align: center;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-label {
                font-size: 14px;
                font-weight: 500;
                color: #6e6e73;
                margin-bottom: 8px;
                display: block;
            }

            .form-input {
                width: 100%;
                border: 1px solid #d2d2d7;
                border-radius: 8px;
                padding: 12px 16px;
                font-size: 16px;
                background: white;
            }

            .form-input:focus {
                outline: none;
                border-color: #0066cc;
            }

            .form-textarea {
                width: 100%;
                border: 1px solid #d2d2d7;
                border-radius: 8px;
                padding: 12px 16px;
                font-size: 16px;
                background: white;
                min-height: 80px;
                resize: vertical;
            }

            .form-textarea:focus {
                outline: none;
                border-color: #0066cc;
            }

            .modal-actions {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 32px;
            }

            .button {
                border: none;
                border-radius: 8px;
                padding: 12px 24px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .button-primary {
                background: #0066cc;
                color: white;
            }

            .button-primary:hover {
                background: #0056b3;
            }

            .button-secondary {
                background: #f2f2f7;
                color: #1d1d1f;
            }

            .button-secondary:hover {
                background: #e5e5ea;
            }

            .button-danger {
                background: #ff3b30;
                color: white;
            }

            .button-danger:hover {
                background: #d70015;
            }

            .loading {
                text-align: center;
                padding: 80px 20px;
                color: #6e6e73;
                font-size: 18px;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            // GraphQL client
            const gql = (strings, ...values) => {
                let result = strings[0];
                for (let i = 1; i < strings.length; i++) {
                    result += values[i - 1] + strings[i];
                }
                return result;
            };

            const useQuery = (query, options = {}) => {
                const [data, setData] = useState(null);
                const [loading, setLoading] = useState(!options.skip);
                const [error, setError] = useState(null);

                const executeQuery = async () => {
                    if (options.skip) return;
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setData(result);
                        setError(null);
                    } catch (err) {
                        setError(err);
                        setData(null);
                    }
                    setLoading(false);
                };

                useEffect(() => {
                    executeQuery();
                }, [query, JSON.stringify(options.variables), options.skip]);

                return { data, loading, error, refetch: executeQuery };
            };

            const useMutation = (mutation) => {
                const [loading, setLoading] = useState(false);

                const executeMutation = async (options = {}) => {
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query: mutation,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        return result;
                    } catch (err) {
                        throw err;
                    } finally {
                        setLoading(false);
                    }
                };

                return [executeMutation, { loading }];
            };

            // GraphQL queries
            const GET_CURRENT_WEEK = gql`
                query {
                    currentWeekStart
                }
            `;

            const GET_PRACTICE_SESSIONS_BY_DAY = gql`
                query ($weekStart: String!) {
                    practiceSessionsByDay(weekStart: $weekStart) {
                        date
                        dayName
                        totalMinutes
                        sessions {
                            id
                            instrument
                            durationMinutes
                            notes
                        }
                    }
                }
            `;

            const GET_WEEKLY_PRACTICE = gql`
                query ($weekStart: String!) {
                    practiceSessionsForWeek(weekStart: $weekStart) {
                        totalMinutes
                    }
                }
            `;

            const CREATE_PRACTICE_SESSION = gql`
                mutation ($input: CreatePracticeSessionInput!) {
                    createPracticeSession(input: $input) {
                        id
                    }
                }
            `;

            const UPDATE_PRACTICE_SESSION = gql`
                mutation ($input: UpdatePracticeSessionInput!) {
                    updatePracticeSession(input: $input) {
                        id
                    }
                }
            `;

            const DELETE_PRACTICE_SESSION = gql`
                mutation ($id: Int!) {
                    deletePracticeSession(id: $id)
                }
            `;

            // Utilities
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.getDate();
            };

            const formatWeekRange = (weekStart) => {
                const start = new Date(weekStart);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);

                const options = { month: "short", day: "numeric" };
                return `${start.toLocaleDateString("en-US", options)} ‚Äì ${end.toLocaleDateString("en-US", options)}`;
            };

            const isToday = (dateStr) => {
                return dateStr === new Date().toISOString().split("T")[0];
            };

            const addWeeks = (dateStr, weeks) => {
                const date = new Date(dateStr);
                date.setDate(date.getDate() + weeks * 7);
                return date.toISOString().split("T")[0];
            };

            const formatMinutes = (minutes) => {
                if (minutes < 60) return `${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
            };

            // Modal Component
            function Modal({ isOpen, onClose, date, session, onSave }) {
                const [instrumentValue, setInstrumentValue] = useState("");
                const [duration, setDuration] = useState("");
                const [notes, setNotes] = useState("");

                const [createSession] = useMutation(CREATE_PRACTICE_SESSION);
                const [updateSession] = useMutation(UPDATE_PRACTICE_SESSION);
                const [deleteSession] = useMutation(DELETE_PRACTICE_SESSION);

                useEffect(() => {
                    if (session) {
                        setInstrumentValue(session.instrument);
                        setDuration(session.durationMinutes.toString());
                        setNotes(session.notes || "");
                    } else {
                        setInstrumentValue("");
                        setDuration("");
                        setNotes("");
                    }
                }, [session, isOpen]);

                const handleSave = async () => {
                    if (!instrumentValue || !duration) return;

                    try {
                        if (session) {
                            await updateSession({
                                variables: {
                                    input: {
                                        id: session.id,
                                        instrument: instrumentValue,
                                        durationMinutes: parseInt(duration),
                                        notes: notes || null,
                                    },
                                },
                            });
                        } else {
                            await createSession({
                                variables: {
                                    input: {
                                        instrument: instrumentValue,
                                        date,
                                        durationMinutes: parseInt(duration),
                                        notes: notes || null,
                                    },
                                },
                            });
                        }
                        onSave();
                        onClose();
                    } catch (error) {
                        console.error(error);
                    }
                };

                const handleDelete = async () => {
                    if (!session) return;
                    try {
                        await deleteSession({ variables: { id: session.id } });
                        onSave();
                        onClose();
                    } catch (error) {
                        console.error(error);
                    }
                };

                if (!isOpen) return null;

                return (
                    <div className="modal">
                        <div className="modal-content">
                            <h3 className="modal-title">
                                {session ? "Edit Practice" : "Add Practice"}
                            </h3>

                            <div className="form-group">
                                <label className="form-label">Instrument</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={instrumentValue}
                                    onChange={(e) =>
                                        setInstrumentValue(e.target.value)
                                    }
                                    placeholder="Piano, Guitar, Violin..."
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Minutes</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={duration}
                                    onChange={(e) =>
                                        setDuration(e.target.value)
                                    }
                                    placeholder="30"
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Notes</label>
                                <textarea
                                    className="form-textarea"
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    placeholder="What did you practice?"
                                />
                            </div>

                            <div className="modal-actions">
                                <button
                                    className="button button-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                                {session && (
                                    <button
                                        className="button button-danger"
                                        onClick={handleDelete}
                                    >
                                        Delete
                                    </button>
                                )}
                                <button
                                    className="button button-primary"
                                    onClick={handleSave}
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main App
            function App() {
                const [currentWeek, setCurrentWeek] = useState("");
                const [modalOpen, setModalOpen] = useState(false);
                const [modalDate, setModalDate] = useState("");
                const [modalSession, setModalSession] = useState(null);

                const { data: weekData, loading: weekLoading } =
                    useQuery(GET_CURRENT_WEEK);

                useEffect(() => {
                    if (weekData?.data?.currentWeekStart && !currentWeek) {
                        setCurrentWeek(weekData.data.currentWeekStart);
                    }
                }, [weekData, currentWeek]);

                const {
                    data: practiceData,
                    loading: practiceLoading,
                    refetch,
                } = useQuery(GET_PRACTICE_SESSIONS_BY_DAY, {
                    variables: { weekStart: currentWeek },
                    skip: !currentWeek,
                });

                const { data: weeklyData, refetch: refetchWeekly } = useQuery(
                    GET_WEEKLY_PRACTICE,
                    {
                        variables: { weekStart: currentWeek },
                        skip: !currentWeek,
                    },
                );

                const practiceByDay =
                    practiceData?.data?.practiceSessionsByDay || [];
                const weeklyTotal =
                    weeklyData?.data?.practiceSessionsForWeek?.totalMinutes ||
                    0;

                const handleDayClick = (date) => {
                    setModalDate(date);
                    setModalSession(null);
                    setModalOpen(true);
                };

                const handleSessionClick = (session, date, e) => {
                    e.stopPropagation();
                    setModalDate(date);
                    setModalSession(session);
                    setModalOpen(true);
                };

                const handleSave = () => {
                    refetch();
                    refetchWeekly();
                };

                if (weekLoading || practiceLoading) {
                    return <div className="loading">Loading...</div>;
                }

                return (
                    <div className="app">
                        <header className="header">
                            <h1 className="title">Practice Music Everyday</h1>
                        </header>

                        <div className="week-nav">
                            <button
                                className="nav-button"
                                onClick={() =>
                                    setCurrentWeek(addWeeks(currentWeek, -1))
                                }
                            >
                                ‚Äπ
                            </button>
                            <div className="week-title">
                                {formatWeekRange(currentWeek)}
                            </div>
                            <button
                                className="nav-button"
                                onClick={() =>
                                    setCurrentWeek(addWeeks(currentWeek, 1))
                                }
                            >
                                ‚Ä∫
                            </button>
                        </div>

                        <div className="calendar">
                            <div className="day-header">Sun</div>
                            <div className="day-header">Mon</div>
                            <div className="day-header">Tue</div>
                            <div className="day-header">Wed</div>
                            <div className="day-header">Thu</div>
                            <div className="day-header">Fri</div>
                            <div className="day-header">Sat</div>

                            {practiceByDay.map((day) => (
                                <div
                                    key={day.date}
                                    className={`day-cell ${
                                        day.totalMinutes > 0
                                            ? "has-practice"
                                            : ""
                                    } ${isToday(day.date) ? "today" : ""}`}
                                    onClick={() => handleDayClick(day.date)}
                                >
                                    <div className="day-date">
                                        {formatDate(day.date)}
                                    </div>
                                    {day.totalMinutes > 0 && (
                                        <div className="day-total">
                                            {formatMinutes(day.totalMinutes)}
                                        </div>
                                    )}
                                    {day.sessions.map((session) => (
                                        <div
                                            key={session.id}
                                            className="session"
                                            onClick={(e) =>
                                                handleSessionClick(
                                                    session,
                                                    day.date,
                                                    e,
                                                )
                                            }
                                        >
                                            {session.instrument}
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>

                        <div className="total-practice">
                            <div className="total-label">
                                Total Practice Time
                            </div>
                            <div className="total-time">
                                {weeklyTotal > 0
                                    ? formatMinutes(weeklyTotal)
                                    : "0m"}
                            </div>
                            <div className="total-subtitle">This week</div>
                        </div>

                        <Modal
                            isOpen={modalOpen}
                            onClose={() => setModalOpen(false)}
                            date={modalDate}
                            session={modalSession}
                            onSave={handleSave}
                        />
                    </div>
                );
            }

            ReactDOM.createRoot(document.getElementById("root")).render(
                <App />,
            );
        </script>
    </body>
</html>
