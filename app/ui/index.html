<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PracticeProgress - Music Learning Tracker</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
        />

        <!-- React -->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.development.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>

        <!-- Babel for JSX transformation -->
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- External CSS -->
        <link rel="stylesheet" href="style.css" />

        <style>
            /* Music Practice Calendar Styles */
            .practice-calendar {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                color: white;
            }

            .calendar-header {
                text-align: center;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 10px;
            }

            .week-navigation {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .nav-btn {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            }

            .nav-btn:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .instrument-section {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
            }

            .instrument-input {
                padding: 8px 12px;
                border-radius: 5px;
                border: 1px solid rgba(255, 255, 255, 0.3);
                background: rgba(255, 255, 255, 0.1);
                color: white;
                min-width: 150px;
            }

            .instrument-input::placeholder {
                color: rgba(255, 255, 255, 0.7);
            }

            .week-grid {
                background: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                margin: 20px 0;
            }

            .week-header {
                background: #4a5568;
                color: white;
                padding: 15px;
                font-weight: bold;
                text-align: center;
                position: relative;
            }

            .music-note {
                position: absolute;
                font-size: 20px;
                opacity: 0.7;
            }

            .music-note.left {
                left: 20px;
                top: 50%;
                transform: translateY(-50%);
            }

            .music-note.right {
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
            }

            .days-header {
                display: grid;
                grid-template-columns: repeat(7, 1fr) auto;
                background: #e2e8f0;
                color: #2d3748;
            }

            .day-header {
                padding: 10px;
                text-align: center;
                font-weight: 600;
                border-right: 1px solid #cbd5e0;
            }

            .total-header {
                padding: 10px;
                text-align: center;
                font-weight: 600;
                background: #4299e1;
                color: white;
                min-width: 100px;
            }

            .days-row {
                display: grid;
                grid-template-columns: repeat(7, 1fr) auto;
                min-height: 120px;
            }

            .day-cell {
                border-right: 1px solid #e2e8f0;
                border-bottom: 1px solid #e2e8f0;
                padding: 10px;
                background: white;
                color: #2d3748;
                position: relative;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .day-cell:hover {
                background: #f7fafc;
            }

            .day-cell.has-practice {
                background: #c6f6d5;
            }

            .day-cell.today {
                background: #fed7d7;
            }

            .day-number {
                font-size: 12px;
                color: #718096;
                margin-bottom: 5px;
            }

            .practice-time {
                font-weight: bold;
                color: #2b6cb0;
                margin-bottom: 5px;
            }

            .practice-sessions {
                font-size: 11px;
                color: #4a5568;
                max-height: 60px;
                overflow-y: auto;
            }

            .session-item {
                margin-bottom: 2px;
                padding: 2px 4px;
                background: rgba(66, 153, 225, 0.1);
                border-radius: 3px;
                cursor: pointer;
            }

            .session-item:hover {
                background: rgba(66, 153, 225, 0.2);
            }

            .total-cell {
                border-bottom: 1px solid #e2e8f0;
                padding: 10px;
                background: #4299e1;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                min-width: 100px;
            }

            .notes-section {
                background: white;
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
                color: #2d3748;
            }

            .notes-header {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
                font-weight: bold;
            }

            .notes-content {
                min-height: 100px;
                background: #f7fafc;
                border-radius: 5px;
                padding: 10px;
                border: 1px solid #e2e8f0;
            }

            .modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal-content {
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 400px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header {
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #e2e8f0;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #2d3748;
            }

            .form-input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #e2e8f0;
                border-radius: 5px;
                font-size: 14px;
            }

            .form-textarea {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #e2e8f0;
                border-radius: 5px;
                font-size: 14px;
                min-height: 80px;
                resize: vertical;
            }

            .modal-actions {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid #e2e8f0;
            }

            .btn {
                padding: 8px 16px;
                border-radius: 5px;
                border: none;
                cursor: pointer;
                font-weight: 600;
            }

            .btn-primary {
                background: #4299e1;
                color: white;
            }

            .btn-secondary {
                background: #e2e8f0;
                color: #2d3748;
            }

            .btn-danger {
                background: #f56565;
                color: white;
            }

            .btn:hover {
                opacity: 0.9;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: white;
            }

            .error-message {
                background: #fed7d7;
                color: #c53030;
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            // Create a simple GraphQL client instead of Apollo for CDN compatibility
            const gql = (strings, ...values) => {
                let result = strings[0];
                for (let i = 1; i < strings.length; i++) {
                    result += values[i - 1] + strings[i];
                }
                return result;
            };

            const useQuery = (query, options = {}) => {
                const [data, setData] = useState(null);
                const [loading, setLoading] = useState(!options.skip);
                const [error, setError] = useState(null);

                const executeQuery = async () => {
                    if (options.skip) return;
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setData(result);
                        setError(null);
                    } catch (err) {
                        setError(err);
                        setData(null);
                    }
                    setLoading(false);
                };

                useEffect(() => {
                    executeQuery();
                }, [query, JSON.stringify(options.variables), options.skip]);

                return { data, loading, error, refetch: executeQuery };
            };

            const useMutation = (mutation) => {
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);

                const executeMutation = async (options = {}) => {
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query: mutation,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setError(null);
                        return result;
                    } catch (err) {
                        setError(err);
                        throw err;
                    } finally {
                        setLoading(false);
                    }
                };

                return [executeMutation, { loading, error }];
            };

            // GraphQL queries and mutations
            const GET_CURRENT_WEEK = gql`
                query {
                    currentWeekStart
                }
            `;

            const GET_PRACTICE_SESSIONS_BY_DAY = gql`
                query ($weekStart: String!, $instrument: String) {
                    practiceSessionsByDay(
                        weekStart: $weekStart
                        instrument: $instrument
                    ) {
                        date
                        dayName
                        totalMinutes
                        sessions {
                            id
                            instrument
                            durationMinutes
                            notes
                        }
                    }
                }
            `;

            const GET_WEEKLY_PRACTICE = gql`
                query ($weekStart: String!, $instrument: String) {
                    practiceSessionsForWeek(
                        weekStart: $weekStart
                        instrument: $instrument
                    ) {
                        weekStart
                        instrument
                        totalMinutes
                        sessions {
                            id
                            instrument
                            date
                            durationMinutes
                            notes
                        }
                    }
                }
            `;

            const GET_AVAILABLE_INSTRUMENTS = gql`
                query {
                    availableInstruments
                }
            `;

            const CREATE_PRACTICE_SESSION = gql`
                mutation ($input: CreatePracticeSessionInput!) {
                    createPracticeSession(input: $input) {
                        id
                        instrument
                        date
                        durationMinutes
                        notes
                    }
                }
            `;

            const UPDATE_PRACTICE_SESSION = gql`
                mutation ($input: UpdatePracticeSessionInput!) {
                    updatePracticeSession(input: $input) {
                        id
                        instrument
                        date
                        durationMinutes
                        notes
                    }
                }
            `;

            const DELETE_PRACTICE_SESSION = gql`
                mutation ($id: Int!) {
                    deletePracticeSession(id: $id)
                }
            `;

            // Utility functions
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString("en-US", {
                    month: "short",
                    day: "numeric",
                });
            };

            const formatWeekRange = (weekStart) => {
                const start = new Date(weekStart);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);

                return `${start.toLocaleDateString("en-US", {
                    month: "short",
                    day: "numeric",
                })} - ${end.toLocaleDateString("en-US", {
                    month: "short",
                    day: "numeric",
                    year: "numeric",
                })}`;
            };

            const isToday = (dateStr) => {
                const today = new Date().toISOString().split("T")[0];
                return dateStr === today;
            };

            const addWeeks = (dateStr, weeks) => {
                const date = new Date(dateStr);
                date.setDate(date.getDate() + weeks * 7);
                return date.toISOString().split("T")[0];
            };

            const formatMinutes = (minutes) => {
                if (minutes < 60) return `${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
            };

            // Practice Session Modal Component
            function PracticeSessionModal({
                isOpen,
                onClose,
                date,
                session,
                onSave,
                onDelete,
                currentInstrument,
            }) {
                const [instrument, setInstrument] = useState(
                    currentInstrument || "",
                );
                const [duration, setDuration] = useState("");
                const [notes, setNotes] = useState("");

                const [createSession, { loading: creating }] = useMutation(
                    CREATE_PRACTICE_SESSION,
                );
                const [updateSession, { loading: updating }] = useMutation(
                    UPDATE_PRACTICE_SESSION,
                );
                const [deleteSession, { loading: deleting }] = useMutation(
                    DELETE_PRACTICE_SESSION,
                );

                useEffect(() => {
                    if (session) {
                        setInstrument(session.instrument);
                        setDuration(session.durationMinutes.toString());
                        setNotes(session.notes || "");
                    } else {
                        setInstrument(currentInstrument || "");
                        setDuration("");
                        setNotes("");
                    }
                }, [session, currentInstrument, isOpen]);

                const handleSave = async () => {
                    if (!instrument || !duration || parseInt(duration) <= 0) {
                        alert("Please fill in instrument and practice time");
                        return;
                    }

                    try {
                        if (session) {
                            // Update existing session
                            await updateSession({
                                variables: {
                                    input: {
                                        id: session.id,
                                        instrument,
                                        durationMinutes: parseInt(duration),
                                        notes: notes || null,
                                    },
                                },
                            });
                        } else {
                            // Create new session
                            await createSession({
                                variables: {
                                    input: {
                                        instrument,
                                        date,
                                        durationMinutes: parseInt(duration),
                                        notes: notes || null,
                                    },
                                },
                            });
                        }
                        onSave();
                        onClose();
                    } catch (error) {
                        alert(
                            "Error saving practice session: " + error.message,
                        );
                    }
                };

                const handleDelete = async () => {
                    if (!session) return;

                    if (
                        confirm(
                            "Are you sure you want to delete this practice session?",
                        )
                    ) {
                        try {
                            await deleteSession({
                                variables: { id: session.id },
                            });
                            onDelete();
                            onClose();
                        } catch (error) {
                            alert(
                                "Error deleting practice session: " +
                                    error.message,
                            );
                        }
                    }
                };

                if (!isOpen) return null;

                return (
                    <div className="modal">
                        <div className="modal-content">
                            <div className="modal-header">
                                <h3>
                                    {session
                                        ? "Edit Practice Session"
                                        : "Add Practice Session"}
                                </h3>
                                <p>{formatDate(date)}</p>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Instrument</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={instrument}
                                    onChange={(e) =>
                                        setInstrument(e.target.value)
                                    }
                                    placeholder="Guitar, Piano, Violin..."
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">
                                    Practice Time (minutes)
                                </label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={duration}
                                    onChange={(e) =>
                                        setDuration(e.target.value)
                                    }
                                    placeholder="30"
                                    min="1"
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">
                                    Notes (optional)
                                </label>
                                <textarea
                                    className="form-textarea"
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    placeholder="What did you practice? Any observations?"
                                />
                            </div>

                            <div className="modal-actions">
                                {session && (
                                    <button
                                        className="btn btn-danger"
                                        onClick={handleDelete}
                                        disabled={deleting}
                                    >
                                        {deleting ? "Deleting..." : "Delete"}
                                    </button>
                                )}
                                <button
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={handleSave}
                                    disabled={creating || updating}
                                >
                                    {creating || updating
                                        ? "Saving..."
                                        : "Save"}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main Practice Calendar Component
            function PracticeCalendar() {
                const [currentWeekStart, setCurrentWeekStart] = useState("");
                const [selectedInstrument, setSelectedInstrument] =
                    useState("");
                const [modalOpen, setModalOpen] = useState(false);
                const [modalDate, setModalDate] = useState("");
                const [modalSession, setModalSession] = useState(null);

                // Get current week
                const { data: currentWeekData, loading: weekLoading } =
                    useQuery(GET_CURRENT_WEEK);

                // Set initial week when data loads
                useEffect(() => {
                    if (
                        currentWeekData?.data?.currentWeekStart &&
                        !currentWeekStart
                    ) {
                        setCurrentWeekStart(
                            currentWeekData.data.currentWeekStart,
                        );
                    }
                }, [currentWeekData, currentWeekStart]);

                // Get practice sessions for current week
                const {
                    data: practiceData,
                    loading: practiceLoading,
                    refetch: refetchPractice,
                } = useQuery(GET_PRACTICE_SESSIONS_BY_DAY, {
                    variables: {
                        weekStart: currentWeekStart,
                        instrument: selectedInstrument || null,
                    },
                    skip: !currentWeekStart,
                });

                // Get weekly totals
                const { data: weeklyData, refetch: refetchWeekly } = useQuery(
                    GET_WEEKLY_PRACTICE,
                    {
                        variables: {
                            weekStart: currentWeekStart,
                            instrument: selectedInstrument || null,
                        },
                        skip: !currentWeekStart,
                    },
                );

                // Get available instruments
                const { data: instrumentsData } = useQuery(
                    GET_AVAILABLE_INSTRUMENTS,
                );

                const practiceByDay =
                    practiceData?.data?.practiceSessionsByDay || [];
                const weeklyTotal =
                    weeklyData?.data?.practiceSessionsForWeek?.totalMinutes ||
                    0;
                const availableInstruments =
                    instrumentsData?.data?.availableInstruments || [];

                const handleDayClick = (date, sessions) => {
                    setModalDate(date);
                    setModalSession(null);
                    setModalOpen(true);
                };

                const handleSessionClick = (session, date, e) => {
                    e.stopPropagation();
                    setModalDate(date);
                    setModalSession(session);
                    setModalOpen(true);
                };

                const handleModalSave = () => {
                    refetchPractice();
                    refetchWeekly();
                };

                const navigateWeek = (direction) => {
                    setCurrentWeekStart(addWeeks(currentWeekStart, direction));
                };

                const loading = weekLoading || practiceLoading;

                if (loading) {
                    return (
                        <div className="loading">
                            Loading your practice calendar...
                        </div>
                    );
                }

                return (
                    <div className="practice-calendar">
                        <div className="calendar-header">
                            <div className="week-navigation">
                                <button
                                    className="nav-btn"
                                    onClick={() => navigateWeek(-1)}
                                >
                                    ‚Äπ
                                </button>
                                <h2>
                                    Week of {formatWeekRange(currentWeekStart)}
                                </h2>
                                <button
                                    className="nav-btn"
                                    onClick={() => navigateWeek(1)}
                                >
                                    ‚Ä∫
                                </button>
                            </div>

                            <div className="instrument-section">
                                <label>Instrument:</label>
                                <input
                                    type="text"
                                    className="instrument-input"
                                    value={selectedInstrument}
                                    onChange={(e) =>
                                        setSelectedInstrument(e.target.value)
                                    }
                                    placeholder="All instruments"
                                    list="instruments"
                                />
                                <datalist id="instruments">
                                    {availableInstruments.map((inst) => (
                                        <option key={inst} value={inst} />
                                    ))}
                                </datalist>
                            </div>
                        </div>

                        <div className="week-grid">
                            <div className="week-header">
                                <span className="music-note left">üéµ</span>
                                <span>
                                    Week of {formatWeekRange(currentWeekStart)}
                                </span>
                                <span className="music-note right">üé∂</span>
                            </div>

                            <div className="days-header">
                                <div className="day-header">Sunday</div>
                                <div className="day-header">Monday</div>
                                <div className="day-header">Tuesday</div>
                                <div className="day-header">Wednesday</div>
                                <div className="day-header">Thursday</div>
                                <div className="day-header">Friday</div>
                                <div className="day-header">Saturday</div>
                                <div className="total-header">
                                    Total Practice Time
                                </div>
                            </div>

                            <div className="days-row">
                                {practiceByDay.map((day) => (
                                    <div
                                        key={day.date}
                                        className={`day-cell ${day.totalMinutes > 0 ? "has-practice" : ""} ${isToday(day.date) ? "today" : ""}`}
                                        onClick={() =>
                                            handleDayClick(
                                                day.date,
                                                day.sessions,
                                            )
                                        }
                                    >
                                        <div className="day-number">
                                            {formatDate(day.date)}
                                        </div>
                                        {day.totalMinutes > 0 && (
                                            <div className="practice-time">
                                                {formatMinutes(
                                                    day.totalMinutes,
                                                )}
                                            </div>
                                        )}
                                        <div className="practice-sessions">
                                            {day.sessions.map((session) => (
                                                <div
                                                    key={session.id}
                                                    className="session-item"
                                                    onClick={(e) =>
                                                        handleSessionClick(
                                                            session,
                                                            day.date,
                                                            e,
                                                        )
                                                    }
                                                    title={session.notes || ""}
                                                >
                                                    {session.instrument} ‚Ä¢{" "}
                                                    {session.durationMinutes}m
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                <div className="total-cell">
                                    {formatMinutes(weeklyTotal)}
                                </div>
                            </div>
                        </div>

                        <div className="notes-section">
                            <div className="notes-header">
                                <span>üìù Notes:</span>
                            </div>
                            <div className="notes-content">
                                Click on any day to add a practice session.
                                Click on existing sessions to edit them.
                                <br />
                                <br />
                                {weeklyTotal > 0 && (
                                    <>
                                        Great job this week! You've practiced
                                        for {formatMinutes(weeklyTotal)} total.
                                        {selectedInstrument && (
                                            <>
                                                {" "}
                                                Your {selectedInstrument}{" "}
                                                practice time is looking good!
                                            </>
                                        )}
                                    </>
                                )}
                                <div
                                    style={{
                                        textAlign: "right",
                                        marginTop: "10px",
                                    }}
                                >
                                    üéº üéµ üé∂ üéπ
                                </div>
                            </div>
                        </div>

                        <PracticeSessionModal
                            isOpen={modalOpen}
                            onClose={() => setModalOpen(false)}
                            date={modalDate}
                            session={modalSession}
                            onSave={handleModalSave}
                            onDelete={handleModalSave}
                            currentInstrument={selectedInstrument}
                        />
                    </div>
                );
            }

            // Root App component
            function App() {
                return (
                    <div
                        style={{
                            minHeight: "100vh",
                            background:
                                "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                            padding: "20px",
                        }}
                    >
                        <PracticeCalendar />
                    </div>
                );
            }

            // Render the app
            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
