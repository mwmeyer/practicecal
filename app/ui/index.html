<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Trello-like Board App</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
        />

        <!-- React -->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.development.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>

        <!-- Babel for JSX transformation -->
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <style>
            :root {
                --board-bg: #0079bf;
                --list-bg: #ebecf0;
                --card-bg: #fff;
                --card-shadow: 0 1px 0 rgba(9, 30, 66, 0.25);
                --card-hover-shadow: 0 2px 6px rgba(9, 30, 66, 0.15);
            }

            body {
                margin: 0;
                background: var(--board-bg);
                color: #172b4d;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
            }

            .navbar {
                background: rgba(0, 0, 0, 0.15);
                padding: 8px 16px;
                display: flex;
                align-items: center;
                gap: 16px;
                backdrop-filter: blur(10px);
            }

            .navbar h1 {
                color: white;
                margin: 0;
                font-size: 18px;
                font-weight: 700;
            }

            .btn-primary {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                padding: 6px 12px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.2s;
            }

            .btn-primary:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .board-container {
                display: flex;
                gap: 12px;
                padding: 16px;
                overflow-x: auto;
                height: calc(100vh - 80px);
                align-items: flex-start;
            }

            .list {
                background: var(--list-bg);
                border-radius: 3px;
                width: 272px;
                flex-shrink: 0;
                max-height: 100%;
                display: flex;
                flex-direction: column;
            }

            .list-header {
                padding: 10px 12px 8px;
                border-bottom: 1px solid #ddd;
            }

            .list-title {
                font-weight: 600;
                font-size: 14px;
                margin: 0;
                padding: 4px 8px;
                background: transparent;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .list-title:hover {
                background: rgba(0, 0, 0, 0.1);
            }

            .list-content {
                padding: 8px;
                flex: 1;
                overflow-y: auto;
            }

            .cards-container {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .card {
                background: var(--card-bg);
                border-radius: 3px;
                box-shadow: var(--card-shadow);
                cursor: pointer;
                transition: box-shadow 0.2s;
                position: relative;
            }

            .card:hover {
                box-shadow: var(--card-hover-shadow);
            }

            .card-content {
                padding: 8px 12px;
            }

            .card-title {
                font-weight: 400;
                font-size: 14px;
                margin: 0 0 4px 0;
                line-height: 1.4;
            }

            .card-description {
                font-size: 12px;
                color: #5e6c84;
                margin: 0 0 8px 0;
                line-height: 1.3;
            }

            .card-meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 11px;
                color: #5e6c84;
            }

            .card-due-date {
                background: #fff3cd;
                color: #856404;
                padding: 2px 6px;
                border-radius: 2px;
            }

            .card-due-date.overdue {
                background: #f8d7da;
                color: #721c24;
            }

            .card-actions {
                opacity: 0;
                transition: opacity 0.2s;
            }

            .card:hover .card-actions {
                opacity: 1;
            }

            .card-delete {
                background: none;
                border: none;
                color: #5e6c84;
                cursor: pointer;
                padding: 2px;
                border-radius: 2px;
            }

            .card-delete:hover {
                background: #ffebee;
                color: #d32f2f;
            }

            .add-card-form {
                margin-top: 8px;
            }

            .add-card-textarea {
                width: 100%;
                min-height: 60px;
                padding: 8px 12px;
                border: none;
                border-radius: 3px;
                resize: vertical;
                font-size: 14px;
                font-family: inherit;
                box-shadow: inset 0 0 0 2px #0079bf;
            }

            .add-card-actions {
                margin-top: 8px;
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .btn-add {
                background: #0079bf;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 14px;
            }

            .btn-add:hover {
                background: #026aa7;
            }

            .btn-cancel {
                background: none;
                border: none;
                color: #5e6c84;
                cursor: pointer;
                font-size: 24px;
                padding: 0;
            }

            .add-card-trigger {
                color: #5e6c84;
                background: none;
                border: none;
                padding: 8px;
                cursor: pointer;
                font-size: 14px;
                width: 100%;
                text-align: left;
                border-radius: 3px;
            }

            .add-card-trigger:hover {
                background: rgba(0, 0, 0, 0.1);
                color: #172b4d;
            }

            .add-list {
                background: rgba(255, 255, 255, 0.24);
                border-radius: 3px;
                width: 272px;
                flex-shrink: 0;
                padding: 12px;
            }

            .add-list-trigger {
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                font-size: 14px;
                width: 100%;
                text-align: left;
                padding: 8px;
                border-radius: 3px;
            }

            .add-list-trigger:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .add-list-form input {
                width: 100%;
                padding: 8px 12px;
                border: none;
                border-radius: 3px;
                font-size: 14px;
                margin-bottom: 8px;
            }

            .modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.64);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal-content {
                background: white;
                border-radius: 8px;
                padding: 24px;
                width: 90%;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .modal-title {
                font-size: 20px;
                font-weight: 600;
                margin: 0;
            }

            .modal-close {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #5e6c84;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                display: block;
                margin-bottom: 4px;
                font-weight: 500;
                font-size: 14px;
            }

            .form-group input,
            .form-group textarea {
                width: 100%;
                padding: 8px 12px;
                border: 2px solid #ddd;
                border-radius: 3px;
                font-size: 14px;
                font-family: inherit;
            }

            .form-group input:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: #0079bf;
            }

            .form-actions {
                display: flex;
                gap: 12px;
                justify-content: flex-end;
            }

            .loading {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 16px 24px;
                border-radius: 4px;
                z-index: 2000;
            }

            .draggable-mirror {
                opacity: 0.8;
                transform: rotate(5deg);
            }

            .card.dragging {
                opacity: 0.5;
                transform: rotate(2deg);
                transition: transform 0.2s;
            }

            .cards-container.drag-over {
                background: rgba(0, 121, 191, 0.1) !important;
                border: 2px dashed #0079bf;
                border-radius: 6px;
                min-height: 60px;
            }

            .cards-container {
                min-height: 40px;
                transition: all 0.2s ease;
            }

            .drop-indicator {
                height: 2px;
                background: #0079bf;
                margin: 4px 0;
                border-radius: 1px;
                opacity: 0;
                transition: opacity 0.2s;
            }

            .drop-indicator.active {
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            // Create a simple GraphQL client instead of Apollo for CDN compatibility
            const gql = (strings, ...values) => {
                let result = strings[0];
                for (let i = 1; i < strings.length; i++) {
                    result += values[i - 1] + strings[i];
                }
                return result;
            };

            const useQuery = (query, options = {}) => {
                const [data, setData] = useState(null);
                const [loading, setLoading] = useState(!options.skip);
                const [error, setError] = useState(null);

                const executeQuery = async () => {
                    if (options.skip) return;
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setData(result);
                        setError(null);
                    } catch (err) {
                        setError(err);
                        setData(null);
                    }
                    setLoading(false);
                };

                useEffect(() => {
                    executeQuery();
                }, [query, JSON.stringify(options.variables), options.skip]);

                return { data, loading, error, refetch: executeQuery };
            };

            const useMutation = (mutation) => {
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);

                const executeMutation = async (options = {}) => {
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query: mutation,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setError(null);
                        return result;
                    } catch (err) {
                        setError(err);
                        throw err;
                    } finally {
                        setLoading(false);
                    }
                };

                return [executeMutation, { loading, error }];
            };

            const ApolloProvider = ({ children }) => children;

            // Simple GraphQL client (no Apollo Client needed for CDN setup)

            // GraphQL queries and mutations
            const GET_BOARDS = gql`
                query {
                    boards {
                        id
                        name
                    }
                }
            `;

            const GET_BOARD = gql`
                query ($id: Int!) {
                    board(id: $id) {
                        id
                        name
                        lists {
                            id
                            name
                            position
                            cards {
                                id
                                title
                                description
                                position
                                dueDate
                            }
                        }
                    }
                }
            `;

            const CREATE_BOARD = gql`
                mutation ($input: CreateBoardInput!) {
                    createBoard(input: $input) {
                        id
                        name
                    }
                }
            `;

            const CREATE_LIST = gql`
                mutation ($input: CreateListInput!) {
                    createList(input: $input) {
                        id
                        name
                        position
                        cards {
                            id
                            title
                            description
                            position
                            dueDate
                        }
                    }
                }
            `;

            const CREATE_CARD = gql`
                mutation ($input: CreateCardInput!) {
                    createCard(input: $input) {
                        id
                        title
                        description
                        position
                        dueDate
                    }
                }
            `;

            const DELETE_CARD = gql`
                mutation ($id: Int!) {
                    deleteCard(id: $id)
                }
            `;

            const MOVE_CARD = gql`
                mutation ($input: MoveCardInput!) {
                    moveCard(input: $input)
                }
            `;

            // Card component
            function Card({ card, listId, onDelete, onMove }) {
                const handleDragStart = (e) => {
                    e.target.classList.add("dragging");
                    e.dataTransfer.setData("text/plain", card.id.toString());
                    e.dataTransfer.effectAllowed = "move";

                    // Add visual feedback to all lists
                    document
                        .querySelectorAll(".cards-container")
                        .forEach((list) => {
                            if (list !== e.target.closest(".cards-container")) {
                                list.style.background =
                                    "rgba(0, 121, 191, 0.05)";
                                list.style.border = "1px dashed #ccc";
                            }
                        });
                };

                const handleDragEnd = (e) => {
                    e.target.classList.remove("dragging");

                    // Remove visual feedback from all lists
                    document
                        .querySelectorAll(".cards-container")
                        .forEach((list) => {
                            list.classList.remove("drag-over");
                            list.style.background = "";
                            list.style.border = "";
                        });
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return "";
                    const date = new Date(dateStr);
                    return date.toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                    });
                };

                const isOverdue = (dateStr) => {
                    if (!dateStr) return false;
                    const today = new Date();
                    const dueDate = new Date(dateStr);
                    return dueDate < today;
                };

                return (
                    <div
                        className="card"
                        data-card-id={card.id}
                        data-list-id={listId}
                        draggable="true"
                        onDragStart={handleDragStart}
                        onDragEnd={handleDragEnd}
                    >
                        <div className="card-content">
                            <h4 className="card-title">{card.title}</h4>
                            {card.description && (
                                <p className="card-description">
                                    {card.description}
                                </p>
                            )}
                            <div className="card-meta">
                                {card.dueDate && (
                                    <span
                                        className={`card-due-date ${isOverdue(card.dueDate) ? "overdue" : ""}`}
                                    >
                                        {formatDate(card.dueDate)}
                                    </span>
                                )}
                                <div className="card-actions">
                                    <button
                                        className="card-delete"
                                        onClick={() => onDelete(card.id)}
                                        title="Delete card"
                                    >
                                        ×
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // List component
            function List({ list, onCreateCard, onDeleteCard, onMoveCard }) {
                const [addingCard, setAddingCard] = useState(false);
                const [newCardTitle, setNewCardTitle] = useState("");
                const textareaRef = useRef(null);

                const handleDragEnter = (e) => {
                    e.preventDefault();
                    e.target
                        .closest(".cards-container")
                        .classList.add("drag-over");
                };

                const handleDragOver = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "move";
                };

                const handleDragLeave = (e) => {
                    const container = e.target.closest(".cards-container");
                    if (!container.contains(e.relatedTarget)) {
                        container.classList.remove("drag-over");
                    }
                };

                const handleDrop = async (e) => {
                    e.preventDefault();
                    const container = e.target.closest(".cards-container");
                    container.classList.remove("drag-over");

                    // Remove visual feedback from all lists
                    document
                        .querySelectorAll(".cards-container")
                        .forEach((l) => {
                            l.style.background = "";
                            l.style.border = "";
                        });

                    const cardId = parseInt(
                        e.dataTransfer.getData("text/plain"),
                    );

                    // Calculate position based on drop location
                    const rect = container.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const cards = Array.from(
                        container.querySelectorAll(".card"),
                    );
                    let position = cards.length;

                    // Find the insertion point
                    for (let i = 0; i < cards.length; i++) {
                        const cardRect = cards[i].getBoundingClientRect();
                        const cardMiddle =
                            cardRect.top + cardRect.height / 2 - rect.top;
                        if (y < cardMiddle) {
                            position = i;
                            break;
                        }
                    }

                    onMoveCard(cardId, list.id, position);
                };

                const startAddCard = () => {
                    setAddingCard(true);
                    setNewCardTitle("");
                    setTimeout(() => {
                        if (textareaRef.current) {
                            textareaRef.current.focus();
                        }
                    }, 0);
                };

                const cancelAddCard = () => {
                    setAddingCard(false);
                    setNewCardTitle("");
                };

                const createCard = () => {
                    if (!newCardTitle.trim()) return;
                    onCreateCard(list.id, newCardTitle.trim());
                    setAddingCard(false);
                    setNewCardTitle("");
                };

                const handleKeyDown = (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        createCard();
                    } else if (e.key === "Escape") {
                        cancelAddCard();
                    }
                };

                return (
                    <div className="list" data-list-id={list.id}>
                        <div className="list-header">
                            <h3 className="list-title">{list.name}</h3>
                        </div>
                        <div className="list-content">
                            <div
                                className="cards-container"
                                id={`list-${list.id}`}
                                onDragEnter={handleDragEnter}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop}
                            >
                                {list.cards?.map((card) => (
                                    <Card
                                        key={card.id}
                                        card={card}
                                        listId={list.id}
                                        onDelete={onDeleteCard}
                                        onMove={onMoveCard}
                                    />
                                ))}
                            </div>

                            {addingCard ? (
                                <div className="add-card-form">
                                    <textarea
                                        ref={textareaRef}
                                        className="add-card-textarea"
                                        value={newCardTitle}
                                        onChange={(e) =>
                                            setNewCardTitle(e.target.value)
                                        }
                                        placeholder="Enter a title for this card..."
                                        onKeyDown={handleKeyDown}
                                    />
                                    <div className="add-card-actions">
                                        <button
                                            className="btn-add"
                                            onClick={createCard}
                                        >
                                            Add Card
                                        </button>
                                        <button
                                            className="btn-cancel"
                                            onClick={cancelAddCard}
                                        >
                                            ×
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <button
                                    className="add-card-trigger"
                                    onClick={startAddCard}
                                >
                                    + Add a card
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // Main Board App component
            function BoardApp() {
                const [addingList, setAddingList] = useState(false);
                const [newListName, setNewListName] = useState("");
                const [error, setError] = useState("");

                const { data: boardsData, loading: boardsLoading } =
                    useQuery(GET_BOARDS);

                console.log(
                    "GET_BOARDS query result:",
                    boardsData,
                    "loading:",
                    boardsLoading,
                );

                if (boardsData?.data) {
                    console.log("Boards data.data:", boardsData.data);
                    console.log("Boards array:", boardsData.data.boards);
                }

                // Get first board ID
                const firstBoardId = boardsData?.data?.boards?.[0]?.id;
                console.log("First board ID:", firstBoardId);

                const {
                    data: boardData,
                    loading: boardLoading,
                    refetch: refetchBoard,
                } = useQuery(GET_BOARD, {
                    variables: { id: firstBoardId },
                    skip: !firstBoardId,
                });

                console.log(
                    "GET_BOARD query result:",
                    boardData,
                    "loading:",
                    boardLoading,
                    "skip:",
                    !firstBoardId,
                );

                const [createBoard] = useMutation(CREATE_BOARD);
                const [createList] = useMutation(CREATE_LIST);
                const [createCard] = useMutation(CREATE_CARD);
                const [deleteCard] = useMutation(DELETE_CARD);
                const [moveCard] = useMutation(MOVE_CARD);

                const currentBoard = boardData?.data?.board || null;
                const loading = boardsLoading || boardLoading;

                // Debug logging
                console.log("Component render - currentBoard:", currentBoard);
                console.log("Component render - loading:", loading);
                console.log("Component render - firstBoardId:", firstBoardId);

                const showError = (msg) => {
                    setError(`Error: ${msg}`);
                    setTimeout(() => setError(""), 5000);
                };

                // Create default board if none exists
                useEffect(() => {
                    const createDefaultBoard = async () => {
                        if (boardsLoading) return;

                        const boards = boardsData?.data?.boards;
                        console.log("Checking for boards:", boards);

                        if (!boards || boards.length === 0) {
                            console.log(
                                "No boards found, creating default board...",
                            );
                            try {
                                await createBoard({
                                    variables: { input: { name: "My Board" } },
                                });
                                console.log(
                                    "Default board created, refetching...",
                                );
                                // The useQuery will automatically refetch
                            } catch (err) {
                                console.error(
                                    "Failed to create default board:",
                                    err,
                                );
                                showError(
                                    "Failed to create default board: " +
                                        err.message,
                                );
                            }
                        }
                    };

                    createDefaultBoard();
                }, [boardsData, boardsLoading]);

                // Simple check for default content
                useEffect(() => {
                    console.log("useEffect triggered!");
                    console.log("useEffect - currentBoard:", currentBoard);
                    console.log("useEffect - loading:", loading);

                    const createDefaultContent = async () => {
                        if (!currentBoard || loading) return;

                        console.log("Checking board:", currentBoard);
                        console.log("Lists:", currentBoard.lists);

                        // Check if we have any cards at all
                        const hasCards = currentBoard.lists?.some(
                            (list) => list.cards?.length > 0,
                        );

                        console.log("Has cards:", hasCards);

                        if (!hasCards) {
                            try {
                                console.log("Creating default content...");
                                // If no lists exist, create default list and card
                                if (
                                    !currentBoard.lists ||
                                    currentBoard.lists.length === 0
                                ) {
                                    console.log("Creating default list...");
                                    // Create default list first
                                    const listResult = await createList({
                                        variables: {
                                            input: {
                                                name: "To Do",
                                                boardId: currentBoard.id,
                                            },
                                        },
                                    });

                                    console.log("List result:", listResult);

                                    // Create default card in the new list
                                    console.log("Creating card in new list...");
                                    const cardResult = await createCard({
                                        variables: {
                                            input: {
                                                title: "Welcome to your board! 👋",
                                                listId: listResult.data
                                                    .createList.id,
                                            },
                                        },
                                    });

                                    console.log("Card result:", cardResult);
                                } else {
                                    console.log(
                                        "Creating card in existing list...",
                                    );
                                    // Create card in first existing list
                                    const cardResult = await createCard({
                                        variables: {
                                            input: {
                                                title: "Welcome to your board! 👋",
                                                listId: currentBoard.lists[0]
                                                    .id,
                                            },
                                        },
                                    });

                                    console.log("Card result:", cardResult);
                                }

                                console.log("Refetching board...");
                                await refetchBoard();
                                console.log("Board refetched successfully");
                            } catch (err) {
                                console.error(
                                    "Error creating default content:",
                                    err,
                                );
                                showError(
                                    "Failed to create default content: " +
                                        err.message,
                                );
                            }
                        }
                    };

                    createDefaultContent();
                }, [currentBoard, loading]);

                const handleCreateList = async (
                    listName,
                    isDefault = false,
                ) => {
                    const name = listName || newListName.trim();
                    if (!name || !currentBoard) return;

                    try {
                        const result = await createList({
                            variables: {
                                input: {
                                    name: name,
                                    boardId: currentBoard.id,
                                },
                            },
                        });

                        await refetchBoard();

                        if (!isDefault) {
                            setNewListName("");
                            setAddingList(false);
                        }
                    } catch (err) {
                        showError(err.message);
                    }
                };

                const handleManualTestCard = async () => {
                    console.log("Manual test button clicked!");
                    alert("Manual test started! Check console.");
                    if (!currentBoard) {
                        alert("No current board!");
                        return;
                    }

                    try {
                        console.log(
                            "Manual test - current board:",
                            currentBoard,
                        );

                        if (
                            !currentBoard.lists ||
                            currentBoard.lists.length === 0
                        ) {
                            console.log("No lists, creating one first...");
                            const listResult = await createList({
                                variables: {
                                    input: {
                                        name: "Test List",
                                        boardId: currentBoard.id,
                                    },
                                },
                            });
                            console.log("Created list:", listResult);

                            await createCard({
                                variables: {
                                    input: {
                                        title: "Manual Test Card! 🎯",
                                        listId: listResult.data.createList.id,
                                    },
                                },
                            });
                        } else {
                            console.log(
                                "Creating card in first list:",
                                currentBoard.lists[0],
                            );
                            await createCard({
                                variables: {
                                    input: {
                                        title: "Manual Test Card! 🎯",
                                        listId: currentBoard.lists[0].id,
                                    },
                                },
                            });
                        }

                        await refetchBoard();
                        console.log("Manual card creation completed");
                    } catch (err) {
                        console.error("Manual test error:", err);
                        showError("Manual test failed: " + err.message);
                    }
                };

                const handleCreateCard = async (listId, title) => {
                    try {
                        await createCard({
                            variables: {
                                input: {
                                    title,
                                    listId: listId,
                                },
                            },
                        });

                        await refetchBoard();
                    } catch (err) {
                        showError(err.message);
                    }
                };

                const handleDeleteCard = async (cardId) => {
                    try {
                        await deleteCard({
                            variables: { id: cardId },
                        });

                        await refetchBoard();
                    } catch (err) {
                        showError(err.message);
                    }
                };

                const handleMoveCard = async (
                    cardId,
                    targetListId,
                    position,
                ) => {
                    try {
                        await moveCard({
                            variables: {
                                input: {
                                    cardId,
                                    targetListId,
                                    position,
                                },
                            },
                        });

                        await refetchBoard();
                    } catch (err) {
                        showError(err.message);
                        await refetchBoard(); // Reload to sync state
                    }
                };

                return (
                    <>
                        {/* Navigation */}
                        <nav className="navbar">
                            <h1>🗂️ {currentBoard?.name || "Board App"}</h1>
                            {currentBoard && (
                                <button
                                    className="btn-primary"
                                    onClick={handleManualTestCard}
                                    style={{ marginLeft: "auto" }}
                                >
                                    🎯 Test Card
                                </button>
                            )}
                        </nav>

                        {/* Board Container */}
                        {currentBoard && (
                            <div
                                className="board-container"
                                id="board-container"
                            >
                                {/* Lists */}
                                {currentBoard.lists?.map((list) => (
                                    <List
                                        key={list.id}
                                        list={list}
                                        onCreateCard={handleCreateCard}
                                        onDeleteCard={handleDeleteCard}
                                        onMoveCard={handleMoveCard}
                                    />
                                ))}

                                {/* Add List */}
                                <div className="add-list">
                                    {!addingList ? (
                                        <button
                                            className="add-list-trigger"
                                            onClick={() => setAddingList(true)}
                                        >
                                            + Add another list
                                        </button>
                                    ) : (
                                        <div className="add-list-form">
                                            <input
                                                type="text"
                                                value={newListName}
                                                onChange={(e) =>
                                                    setNewListName(
                                                        e.target.value,
                                                    )
                                                }
                                                placeholder="Enter list title..."
                                                onKeyDown={(e) => {
                                                    if (e.key === "Enter")
                                                        handleCreateList();
                                                    if (e.key === "Escape") {
                                                        setAddingList(false);
                                                        setNewListName("");
                                                    }
                                                }}
                                            />
                                            <div className="add-card-actions">
                                                <button
                                                    className="btn-add"
                                                    onClick={() =>
                                                        handleCreateList()
                                                    }
                                                >
                                                    Add List
                                                </button>
                                                <button
                                                    className="btn-cancel"
                                                    onClick={() => {
                                                        setAddingList(false);
                                                        setNewListName("");
                                                    }}
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Loading Indicator */}
                        {loading && (
                            <div className="loading">
                                <div>Loading...</div>
                            </div>
                        )}

                        {/* Error Display */}
                        {error && (
                            <div
                                style={{
                                    position: "fixed",
                                    top: "20px",
                                    right: "20px",
                                    background: "#f8d7da",
                                    color: "#721c24",
                                    padding: "12px",
                                    borderRadius: "4px",
                                    zIndex: 1000,
                                }}
                            >
                                {error}
                            </div>
                        )}
                    </>
                );
            }

            // Root App component
            function App() {
                return <BoardApp />;
            }

            // Render the app
            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
