<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üóìÔ∏èPracticeCal</title>

        <!-- React -->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.development.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- External CSS -->
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            // GraphQL client
            const gql = (strings, ...values) => {
                let result = strings[0];
                for (let i = 1; i < strings.length; i++) {
                    result += values[i - 1] + strings[i];
                }
                return result;
            };

            const useQuery = (query, options = {}) => {
                const [data, setData] = useState(null);
                const [loading, setLoading] = useState(!options.skip);
                const [error, setError] = useState(null);

                const executeQuery = async () => {
                    if (options.skip) return;
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setData(result);
                        setError(null);
                    } catch (err) {
                        setError(err);
                        setData(null);
                    }
                    setLoading(false);
                };

                useEffect(() => {
                    executeQuery();
                }, [query, JSON.stringify(options.variables), options.skip]);

                return { data, loading, error, refetch: executeQuery };
            };

            const useMutation = (mutation) => {
                const [loading, setLoading] = useState(false);

                const executeMutation = async (options = {}) => {
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query: mutation,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        return result;
                    } catch (err) {
                        throw err;
                    } finally {
                        setLoading(false);
                    }
                };

                return [executeMutation, { loading }];
            };

            // GraphQL queries
            const GET_CURRENT_WEEK = gql`
                query {
                    currentWeekStart
                }
            `;

            const GET_PRACTICE_SESSIONS_BY_DAY = gql`
                query ($weekStart: String!) {
                    practiceSessionsByDay(weekStart: $weekStart) {
                        date
                        dayName
                        totalMinutes
                        sessions {
                            id
                            durationMinutes
                        }
                    }
                }
            `;

            const GET_WEEKLY_PRACTICE = gql`
                query ($weekStart: String!) {
                    practiceSessionsForWeek(weekStart: $weekStart) {
                        totalMinutes
                    }
                }
            `;

            const CREATE_PRACTICE_SESSION = gql`
                mutation ($input: CreatePracticeSessionInput!) {
                    createPracticeSession(input: $input) {
                        id
                    }
                }
            `;

            const UPDATE_PRACTICE_SESSION = gql`
                mutation ($input: UpdatePracticeSessionInput!) {
                    updatePracticeSession(input: $input) {
                        id
                    }
                }
            `;

            const DELETE_PRACTICE_SESSION = gql`
                mutation ($id: Int!) {
                    deletePracticeSession(id: $id)
                }
            `;

            // Utilities
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.getDate();
            };

            const formatWeekRange = (weekStart) => {
                const start = new Date(weekStart);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);

                const options = { month: "short", day: "numeric" };
                return `${start.toLocaleDateString("en-US", options)} ‚Äì ${end.toLocaleDateString("en-US", options)}`;
            };

            const isToday = (dateStr) => {
                return dateStr === new Date().toISOString().split("T")[0];
            };

            const addWeeks = (dateStr, weeks) => {
                const date = new Date(dateStr);
                date.setDate(date.getDate() + weeks * 7);
                return date.toISOString().split("T")[0];
            };

            const formatMinutes = (minutes) => {
                if (minutes < 60) return `${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
            };

            // Modal Component
            function Modal({ isOpen, onClose, date, session, onSave }) {
                const [duration, setDuration] = useState("");

                const [createSession] = useMutation(CREATE_PRACTICE_SESSION);
                const [updateSession] = useMutation(UPDATE_PRACTICE_SESSION);
                const [deleteSession] = useMutation(DELETE_PRACTICE_SESSION);

                useEffect(() => {
                    if (session) {
                        setDuration(session.durationMinutes.toString());
                    } else {
                        setDuration("");
                    }
                }, [session, isOpen]);

                const handleSave = async () => {
                    if (!duration || parseInt(duration) <= 0) return;

                    try {
                        if (session) {
                            await updateSession({
                                variables: {
                                    input: {
                                        id: session.id,
                                        durationMinutes: parseInt(duration),
                                    },
                                },
                            });
                        } else {
                            await createSession({
                                variables: {
                                    input: {
                                        date,
                                        durationMinutes: parseInt(duration),
                                    },
                                },
                            });
                        }
                        onSave();
                        onClose();
                    } catch (error) {
                        console.error(error);
                    }
                };

                const handleDelete = async () => {
                    if (!session) return;
                    try {
                        await deleteSession({ variables: { id: session.id } });
                        onSave();
                        onClose();
                    } catch (error) {
                        console.error(error);
                    }
                };

                if (!isOpen) return null;

                return (
                    <div className="modal">
                        <div className="modal-content">
                            <h3 className="modal-title">
                                {session ? "Edit Practice" : "Add Practice"}
                            </h3>

                            <div className="form-group">
                                <label className="form-label">Minutes</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={duration}
                                    onChange={(e) =>
                                        setDuration(e.target.value)
                                    }
                                    placeholder="30"
                                    min="1"
                                    autoFocus
                                />
                            </div>

                            <div className="modal-actions">
                                <button
                                    className="button button-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                                {session && (
                                    <button
                                        className="button button-danger"
                                        onClick={handleDelete}
                                    >
                                        Delete
                                    </button>
                                )}
                                <button
                                    className="button button-primary"
                                    onClick={handleSave}
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main App
            function App() {
                const [currentWeek, setCurrentWeek] = useState("");
                const [modalOpen, setModalOpen] = useState(false);
                const [modalDate, setModalDate] = useState("");
                const [modalSession, setModalSession] = useState(null);

                const { data: weekData, loading: weekLoading } =
                    useQuery(GET_CURRENT_WEEK);

                useEffect(() => {
                    if (weekData?.data?.currentWeekStart && !currentWeek) {
                        setCurrentWeek(weekData.data.currentWeekStart);
                    }
                }, [weekData, currentWeek]);

                const {
                    data: practiceData,
                    loading: practiceLoading,
                    refetch,
                } = useQuery(GET_PRACTICE_SESSIONS_BY_DAY, {
                    variables: { weekStart: currentWeek },
                    skip: !currentWeek,
                });

                const { data: weeklyData, refetch: refetchWeekly } = useQuery(
                    GET_WEEKLY_PRACTICE,
                    {
                        variables: { weekStart: currentWeek },
                        skip: !currentWeek,
                    },
                );

                const practiceByDay =
                    practiceData?.data?.practiceSessionsByDay || [];
                const weeklyTotal =
                    weeklyData?.data?.practiceSessionsForWeek?.totalMinutes ||
                    0;

                const handleDayClick = (date) => {
                    setModalDate(date);
                    setModalSession(null);
                    setModalOpen(true);
                };

                const handleSessionClick = (session, date, e) => {
                    e.stopPropagation();
                    setModalDate(date);
                    setModalSession(session);
                    setModalOpen(true);
                };

                const handleSave = () => {
                    refetch();
                    refetchWeekly();
                };

                if (weekLoading || practiceLoading) {
                    return <div className="loading">Loading...</div>;
                }

                return (
                    <div className="app">
                        <header className="header">
                            <h1 className="title">üóìÔ∏èPracticeCal</h1>
                        </header>

                        <div className="week-nav">
                            <button
                                className="nav-button"
                                onClick={() =>
                                    setCurrentWeek(addWeeks(currentWeek, -1))
                                }
                            >
                                ‚Äπ
                            </button>
                            <div className="week-title">
                                {formatWeekRange(currentWeek)}
                            </div>
                            <button
                                className="nav-button"
                                onClick={() =>
                                    setCurrentWeek(addWeeks(currentWeek, 1))
                                }
                            >
                                ‚Ä∫
                            </button>
                        </div>

                        <div className="calendar">
                            <div className="calendar-row">
                                <div className="day-header">Sun</div>
                                <div className="day-header">Mon</div>
                                <div className="day-header">Tue</div>
                                <div className="day-header">Wed</div>
                                <div className="day-header">Thu</div>
                                <div className="day-header">Fri</div>
                                <div className="day-header">Sat</div>
                            </div>
                            <div className="calendar-row">
                                {practiceByDay.map((day) => (
                                    <div
                                        key={day.date}
                                        className={`day-cell ${
                                            day.totalMinutes > 0
                                                ? "has-practice"
                                                : ""
                                        } ${isToday(day.date) ? "today" : ""}`}
                                        onClick={() => handleDayClick(day.date)}
                                    >
                                        <div className="day-date">
                                            {formatDate(day.date)}
                                        </div>
                                        {day.totalMinutes > 0 && (
                                            <div className="day-total">
                                                {formatMinutes(
                                                    day.totalMinutes,
                                                )}
                                            </div>
                                        )}
                                        {day.sessions.map((session) => (
                                            <div
                                                key={session.id}
                                                className="session"
                                                onClick={(e) =>
                                                    handleSessionClick(
                                                        session,
                                                        day.date,
                                                        e,
                                                    )
                                                }
                                            >
                                                {formatMinutes(
                                                    session.durationMinutes,
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="total-practice">
                            <div className="total-label">
                                Total Practice Time
                            </div>
                            <div className="total-time">
                                {weeklyTotal > 0
                                    ? formatMinutes(weeklyTotal)
                                    : "0m"}
                            </div>
                            <div className="total-subtitle">This week</div>
                        </div>

                        <Modal
                            isOpen={modalOpen}
                            onClose={() => setModalOpen(false)}
                            date={modalDate}
                            session={modalSession}
                            onSave={handleSave}
                        />
                    </div>
                );
            }

            ReactDOM.createRoot(document.getElementById("root")).render(
                <App />,
            );
        </script>
    </body>
</html>
