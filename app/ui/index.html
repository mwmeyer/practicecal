<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PracticeProgress - Music Learning Tracker</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
        />

        <!-- React -->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.development.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>

        <!-- Babel for JSX transformation -->
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- External CSS -->
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            // Create a simple GraphQL client instead of Apollo for CDN compatibility
            const gql = (strings, ...values) => {
                let result = strings[0];
                for (let i = 1; i < strings.length; i++) {
                    result += values[i - 1] + strings[i];
                }
                return result;
            };

            const useQuery = (query, options = {}) => {
                const [data, setData] = useState(null);
                const [loading, setLoading] = useState(!options.skip);
                const [error, setError] = useState(null);

                const executeQuery = async () => {
                    if (options.skip) return;
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setData(result);
                        setError(null);
                    } catch (err) {
                        setError(err);
                        setData(null);
                    }
                    setLoading(false);
                };

                useEffect(() => {
                    executeQuery();
                }, [query, JSON.stringify(options.variables), options.skip]);

                return { data, loading, error, refetch: executeQuery };
            };

            const useMutation = (mutation) => {
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);

                const executeMutation = async (options = {}) => {
                    setLoading(true);
                    try {
                        const response = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                query: mutation,
                                variables: options.variables || {},
                            }),
                        });
                        const result = await response.json();
                        if (result.errors) {
                            throw new Error(result.errors[0].message);
                        }
                        setError(null);
                        return result;
                    } catch (err) {
                        setError(err);
                        throw err;
                    } finally {
                        setLoading(false);
                    }
                };

                return [executeMutation, { loading, error }];
            };

            const ApolloProvider = ({ children }) => children;

            // Simple GraphQL client (no Apollo Client needed for CDN setup)

            // GraphQL queries and mutations
            const GET_BOARDS = gql`
                query {
                    boards {
                        id
                        name
                    }
                }
            `;

            const GET_BOARD = gql`
                query ($id: Int!) {
                    board(id: $id) {
                        id
                        name
                        lists {
                            id
                            name
                            position
                            cards {
                                id
                                title
                                description
                                position
                                dueDate
                            }
                        }
                    }
                }
            `;

            const CREATE_BOARD = gql`
                mutation ($input: CreateBoardInput!) {
                    createBoard(input: $input) {
                        id
                        name
                    }
                }
            `;

            const CREATE_LIST = gql`
                mutation ($input: CreateListInput!) {
                    createList(input: $input) {
                        id
                        name
                        position
                        cards {
                            id
                            title
                            description
                            position
                            dueDate
                        }
                    }
                }
            `;

            const CREATE_CARD = gql`
                mutation ($input: CreateCardInput!) {
                    createCard(input: $input) {
                        id
                        title
                        description
                        position
                        dueDate
                    }
                }
            `;

            const DELETE_CARD = gql`
                mutation ($id: Int!) {
                    deleteCard(id: $id)
                }
            `;

            const MOVE_CARD = gql`
                mutation ($input: MoveCardInput!) {
                    moveCard(input: $input)
                }
            `;

            // Card component
            function Card({ card, listId, onDelete, onMove }) {
                const handleDragStart = (e) => {
                    e.target.classList.add("dragging");
                    e.dataTransfer.setData("text/plain", card.id.toString());
                    e.dataTransfer.effectAllowed = "move";

                    // Add visual feedback to all lists
                    document
                        .querySelectorAll(".cards-container")
                        .forEach((list) => {
                            if (list !== e.target.closest(".cards-container")) {
                                list.style.background =
                                    "rgba(0, 121, 191, 0.05)";
                                list.style.border = "1px dashed #ccc";
                            }
                        });
                };

                const handleDragEnd = (e) => {
                    e.target.classList.remove("dragging");

                    // Remove visual feedback from all lists
                    document
                        .querySelectorAll(".cards-container")
                        .forEach((list) => {
                            list.classList.remove("drag-over");
                            list.style.background = "";
                            list.style.border = "";
                        });
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return "";
                    const date = new Date(dateStr);
                    return date.toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                    });
                };

                const isOverdue = (dateStr) => {
                    if (!dateStr) return false;
                    const today = new Date();
                    const dueDate = new Date(dateStr);
                    return dueDate < today;
                };

                return (
                    <div
                        className="card"
                        data-card-id={card.id}
                        data-list-id={listId}
                        draggable="true"
                        onDragStart={handleDragStart}
                        onDragEnd={handleDragEnd}
                    >
                        <div className="card-content">
                            <h4 className="card-title">{card.title}</h4>
                            {card.description && (
                                <p className="card-description">
                                    {card.description}
                                </p>
                            )}
                            <div className="card-meta">
                                {card.dueDate && (
                                    <span
                                        className={`card-due-date ${isOverdue(card.dueDate) ? "overdue" : ""}`}
                                    >
                                        {formatDate(card.dueDate)}
                                    </span>
                                )}
                                <div className="card-actions">
                                    <button
                                        className="card-delete"
                                        onClick={() => onDelete(card.id)}
                                        title="Delete card"
                                    >
                                        Ã—
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // List component
            function List({ list, onCreateCard, onDeleteCard, onMoveCard }) {
                const [addingCard, setAddingCard] = useState(false);
                const [newCardTitle, setNewCardTitle] = useState("");
                const textareaRef = useRef(null);

                const handleDragEnter = (e) => {
                    e.preventDefault();
                    e.target
                        .closest(".cards-container")
                        .classList.add("drag-over");
                };

                const handleDragOver = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "move";
                };

                const handleDragLeave = (e) => {
                    const container = e.target.closest(".cards-container");
                    if (!container.contains(e.relatedTarget)) {
                        container.classList.remove("drag-over");
                    }
                };

                const handleDrop = async (e) => {
                    e.preventDefault();
                    const container = e.target.closest(".cards-container");
                    container.classList.remove("drag-over");

                    // Remove visual feedback from all lists
                    document
                        .querySelectorAll(".cards-container")
                        .forEach((l) => {
                            l.style.background = "";
                            l.style.border = "";
                        });

                    const cardId = parseInt(
                        e.dataTransfer.getData("text/plain"),
                    );

                    // Calculate position based on drop location
                    const rect = container.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const cards = Array.from(
                        container.querySelectorAll(".card"),
                    );
                    let position = cards.length;

                    // Find the insertion point
                    for (let i = 0; i < cards.length; i++) {
                        const cardRect = cards[i].getBoundingClientRect();
                        const cardMiddle =
                            cardRect.top + cardRect.height / 2 - rect.top;
                        if (y < cardMiddle) {
                            position = i;
                            break;
                        }
                    }

                    onMoveCard(cardId, list.id, position);
                };

                const startAddCard = () => {
                    setAddingCard(true);
                    setNewCardTitle("");
                    setTimeout(() => {
                        if (textareaRef.current) {
                            textareaRef.current.focus();
                        }
                    }, 0);
                };

                const cancelAddCard = () => {
                    setAddingCard(false);
                    setNewCardTitle("");
                };

                const createCard = () => {
                    if (!newCardTitle.trim()) return;
                    onCreateCard(list.id, newCardTitle.trim());
                    setAddingCard(false);
                    setNewCardTitle("");
                };

                const handleKeyDown = (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        createCard();
                    } else if (e.key === "Escape") {
                        cancelAddCard();
                    }
                };

                return (
                    <div className="list" data-list-id={list.id}>
                        <div className="list-header">
                            <h3 className="list-title">{list.name}</h3>
                        </div>
                        <div className="list-content">
                            <div
                                className="cards-container"
                                id={`list-${list.id}`}
                                onDragEnter={handleDragEnter}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop}
                            >
                                {list.cards?.map((card) => (
                                    <Card
                                        key={card.id}
                                        card={card}
                                        listId={list.id}
                                        onDelete={onDeleteCard}
                                        onMove={onMoveCard}
                                    />
                                ))}
                            </div>

                            {addingCard ? (
                                <div className="add-card-form">
                                    <textarea
                                        ref={textareaRef}
                                        className="add-card-textarea"
                                        value={newCardTitle}
                                        onChange={(e) =>
                                            setNewCardTitle(e.target.value)
                                        }
                                        placeholder="What would you like to practice?"
                                        onKeyDown={handleKeyDown}
                                    />
                                    <div className="add-card-actions">
                                        <button
                                            className="btn-add"
                                            onClick={createCard}
                                        >
                                            Add Practice Item
                                        </button>
                                        <button
                                            className="btn-cancel"
                                            onClick={cancelAddCard}
                                        >
                                            Ã—
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <button
                                    className="add-card-trigger"
                                    onClick={startAddCard}
                                >
                                    + Add practice item
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // Main Board App component
            function BoardApp() {
                const [addingList, setAddingList] = useState(false);
                const [newListName, setNewListName] = useState("");
                const [error, setError] = useState("");

                const { data: boardsData, loading: boardsLoading } =
                    useQuery(GET_BOARDS);

                console.log(
                    "GET_BOARDS query result:",
                    boardsData,
                    "loading:",
                    boardsLoading,
                );

                if (boardsData?.data) {
                    console.log("Boards data.data:", boardsData.data);
                    console.log("Boards array:", boardsData.data.boards);
                }

                // Get first board ID
                const firstBoardId = boardsData?.data?.boards?.[0]?.id;
                console.log("First board ID:", firstBoardId);

                const {
                    data: boardData,
                    loading: boardLoading,
                    refetch: refetchBoard,
                } = useQuery(GET_BOARD, {
                    variables: { id: firstBoardId },
                    skip: !firstBoardId,
                });

                console.log(
                    "GET_BOARD query result:",
                    boardData,
                    "loading:",
                    boardLoading,
                    "skip:",
                    !firstBoardId,
                );

                const [createBoard] = useMutation(CREATE_BOARD);
                const [createList] = useMutation(CREATE_LIST);
                const [createCard] = useMutation(CREATE_CARD);
                const [deleteCard] = useMutation(DELETE_CARD);
                const [moveCard] = useMutation(MOVE_CARD);

                const currentBoard = boardData?.data?.board || null;
                const loading = boardsLoading || boardLoading;

                // Debug logging
                console.log("Component render - currentBoard:", currentBoard);
                console.log("Component render - loading:", loading);
                console.log("Component render - firstBoardId:", firstBoardId);

                const showError = (msg) => {
                    setError(`Error: ${msg}`);
                    setTimeout(() => setError(""), 5000);
                };

                // Create default board if none exists
                useEffect(() => {
                    const createDefaultBoard = async () => {
                        if (boardsLoading) return;

                        const boards = boardsData?.data?.boards;
                        console.log("Checking for boards:", boards);

                        if (!boards || boards.length === 0) {
                            console.log(
                                "No practice space found, creating your first one...",
                            );
                            try {
                                await createBoard({
                                    variables: {
                                        input: { name: "My Practice Journey" },
                                    },
                                });
                                console.log(
                                    "Practice space created, loading...",
                                );
                                // The useQuery will automatically refetch
                            } catch (err) {
                                console.error(
                                    "Failed to create default board:",
                                    err,
                                );
                                showError(
                                    "Couldn't set up your practice space: " +
                                        err.message,
                                );
                            }
                        }
                    };

                    createDefaultBoard();
                }, [boardsData, boardsLoading]);

                // Simple check for default content
                useEffect(() => {
                    console.log("useEffect triggered!");
                    console.log("useEffect - currentBoard:", currentBoard);
                    console.log("useEffect - loading:", loading);

                    const createDefaultContent = async () => {
                        if (!currentBoard || loading) return;

                        console.log("Checking board:", currentBoard);
                        console.log("Lists:", currentBoard.lists);

                        // Check if we have any cards at all
                        const hasCards = currentBoard.lists?.some(
                            (list) => list.cards?.length > 0,
                        );

                        console.log("Has cards:", hasCards);

                        if (!hasCards) {
                            try {
                                console.log("Creating default content...");
                                // If no lists exist, create default list and card
                                if (
                                    !currentBoard.lists ||
                                    currentBoard.lists.length === 0
                                ) {
                                    console.log("Creating default list...");
                                    // Create multiple default practice categories
                                    const categories = [
                                        {
                                            name: "Songs to Learn",
                                            items: [
                                                "Choose a song you love ðŸŽµ",
                                                "Start with simple chords",
                                            ],
                                        },
                                        {
                                            name: "Scales & Exercises",
                                            items: [
                                                "Practice major scale",
                                                "Work on finger exercises",
                                            ],
                                        },
                                        {
                                            name: "Music Theory",
                                            items: [
                                                "Learn chord progressions",
                                                "Study circle of fifths",
                                            ],
                                        },
                                        { name: "Practice Log", items: [] },
                                    ];

                                    for (const category of categories) {
                                        const listResult = await createList({
                                            variables: {
                                                input: {
                                                    name: category.name,
                                                    boardId: currentBoard.id,
                                                },
                                            },
                                        });

                                        console.log(
                                            `Created category: ${category.name}`,
                                        );

                                        // Add default items to each category
                                        for (const item of category.items) {
                                            await createCard({
                                                variables: {
                                                    input: {
                                                        title: item,
                                                        listId: listResult.data
                                                            .createList.id,
                                                    },
                                                },
                                            });
                                        }
                                    }
                                } else {
                                    // Add some starter practice items to existing categories
                                    console.log(
                                        "Adding starter practice items...",
                                    );

                                    const starterItems = [
                                        "Pick a favorite song to learn ðŸŽµ",
                                        "Practice 10 minutes daily",
                                        "Record yourself playing",
                                    ];

                                    for (
                                        let i = 0;
                                        i <
                                        Math.min(
                                            starterItems.length,
                                            currentBoard.lists.length,
                                        );
                                        i++
                                    ) {
                                        await createCard({
                                            variables: {
                                                input: {
                                                    title: starterItems[i],
                                                    listId: currentBoard.lists[
                                                        i
                                                    ].id,
                                                },
                                            },
                                        });
                                    }
                                }

                                console.log("Refetching board...");
                                await refetchBoard();
                                console.log("Board refetched successfully");
                            } catch (err) {
                                console.error(
                                    "Error creating default content:",
                                    err,
                                );
                                showError(
                                    "Couldn't add your first practice item: " +
                                        err.message,
                                );
                            }
                        }
                    };

                    createDefaultContent();
                }, [currentBoard, loading]);

                const handleCreateList = async (
                    listName,
                    isDefault = false,
                ) => {
                    const name = listName || newListName.trim();
                    if (!name || !currentBoard) return;

                    try {
                        const result = await createList({
                            variables: {
                                input: {
                                    name: name,
                                    boardId: currentBoard.id,
                                },
                            },
                        });

                        await refetchBoard();

                        if (!isDefault) {
                            setNewListName("");
                            setAddingList(false);
                        }
                    } catch (err) {
                        showError(err.message);
                    }
                };

                const handleManualTestCard = async () => {
                    console.log("Quick practice button clicked!");
                    alert("Adding a quick practice item!");
                    if (!currentBoard) {
                        alert("Practice space not ready!");
                        return;
                    }

                    try {
                        console.log(
                            "Manual test - current board:",
                            currentBoard,
                        );

                        if (
                            !currentBoard.lists ||
                            currentBoard.lists.length === 0
                        ) {
                            console.log("No lists, creating one first...");
                            const listResult = await createList({
                                variables: {
                                    input: {
                                        name: "Practice Sessions",
                                        boardId: currentBoard.id,
                                    },
                                },
                            });
                            console.log("Created list:", listResult);

                            await createCard({
                                variables: {
                                    input: {
                                        title: "Work on rhythm exercises ðŸ¥",
                                        listId: listResult.data.createList.id,
                                    },
                                },
                            });
                        } else {
                            console.log(
                                "Creating card in first list:",
                                currentBoard.lists[0],
                            );
                            await createCard({
                                variables: {
                                    input: {
                                        title: "Work on rhythm exercises ðŸ¥",
                                        listId: currentBoard.lists[0].id,
                                    },
                                },
                            });
                        }

                        await refetchBoard();
                        console.log("Quick practice item added");
                    } catch (err) {
                        console.error("Quick practice error:", err);
                        showError("Couldn't add practice item: " + err.message);
                    }
                };

                const handleCreateCard = async (listId, title) => {
                    try {
                        await createCard({
                            variables: {
                                input: {
                                    title,
                                    listId: listId,
                                },
                            },
                        });

                        await refetchBoard();
                    } catch (err) {
                        showError(err.message);
                    }
                };

                const handleDeleteCard = async (cardId) => {
                    try {
                        await deleteCard({
                            variables: { id: cardId },
                        });

                        await refetchBoard();
                    } catch (err) {
                        showError(err.message);
                    }
                };

                const handleMoveCard = async (
                    cardId,
                    targetListId,
                    position,
                ) => {
                    try {
                        await moveCard({
                            variables: {
                                input: {
                                    cardId,
                                    targetListId,
                                    position,
                                },
                            },
                        });

                        await refetchBoard();
                    } catch (err) {
                        showError(err.message);
                        await refetchBoard(); // Reload to sync state
                    }
                };

                return (
                    <>
                        {/* Navigation */}
                        <nav className="navbar">
                            <h1>
                                ðŸŽµ {currentBoard?.name || "PracticeProgress"}
                            </h1>
                            {currentBoard && (
                                <button
                                    className="btn-primary"
                                    onClick={handleManualTestCard}
                                    style={{ marginLeft: "auto" }}
                                >
                                    âž• Quick Practice
                                </button>
                            )}
                        </nav>

                        {/* Board Container */}
                        {currentBoard && (
                            <div
                                className="board-container"
                                id="board-container"
                            >
                                {/* Lists */}
                                {currentBoard.lists?.map((list) => (
                                    <List
                                        key={list.id}
                                        list={list}
                                        onCreateCard={handleCreateCard}
                                        onDeleteCard={handleDeleteCard}
                                        onMoveCard={handleMoveCard}
                                    />
                                ))}

                                {/* Add List */}
                                <div className="add-list">
                                    {!addingList ? (
                                        <button
                                            className="add-list-trigger"
                                            onClick={() => setAddingList(true)}
                                        >
                                            + Add practice category
                                        </button>
                                    ) : (
                                        <div className="add-list-form">
                                            <input
                                                type="text"
                                                value={newListName}
                                                onChange={(e) =>
                                                    setNewListName(
                                                        e.target.value,
                                                    )
                                                }
                                                placeholder="e.g. Jazz Standards, Classical Pieces, Improvisation..."
                                                onKeyDown={(e) => {
                                                    if (e.key === "Enter")
                                                        handleCreateList();
                                                    if (e.key === "Escape") {
                                                        setAddingList(false);
                                                        setNewListName("");
                                                    }
                                                }}
                                            />
                                            <div className="add-card-actions">
                                                <button
                                                    className="btn-add"
                                                    onClick={() =>
                                                        handleCreateList()
                                                    }
                                                >
                                                    Add Category
                                                </button>
                                                <button
                                                    className="btn-cancel"
                                                    onClick={() => {
                                                        setAddingList(false);
                                                        setNewListName("");
                                                    }}
                                                >
                                                    Ã—
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Loading Indicator */}
                        {loading && (
                            <div className="loading">
                                <div>Loading...</div>
                            </div>
                        )}

                        {/* Error Display */}
                        {error && (
                            <div
                                style={{
                                    position: "fixed",
                                    top: "20px",
                                    right: "20px",
                                    background: "#f8d7da",
                                    color: "#721c24",
                                    padding: "12px",
                                    borderRadius: "4px",
                                    zIndex: 1000,
                                }}
                            >
                                {error}
                            </div>
                        )}
                    </>
                );
            }

            // Root App component
            function App() {
                return <BoardApp />;
            }

            // Render the app
            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
