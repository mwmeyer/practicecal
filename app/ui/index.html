<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>GraphQL Todo App</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
        />
        <script src="https://unpkg.com/alpinejs" defer></script>
    </head>
    <body>
        <main class="container" x-data="todoApp()">
            <h1>To-Do List üìù</h1>

            <form @submit.prevent="addTodo()">
                <input
                    type="text"
                    x-model="newTask"
                    placeholder="New to-do"
                    required
                    autocomplete="off"
                />
                <button type="submit" :disabled="loading">Add</button>
            </form>

            <ul>
                <template x-for="todo in todos" :key="todo.id">
                    <li>
                        <span x-text="todo.task"></span>
                        <button
                            @click="deleteTodo(todo.id)"
                            title="Delete todo"
                            :disabled="loading"
                        >
                            ‚ùå
                        </button>
                    </li>
                </template>
            </ul>

            <div x-show="loading" aria-busy="true">Loading...</div>

            <div
                x-show="error"
                x-text="error"
                style="color: var(--pico-color-red-500)"
            ></div>
        </main>

        <script>
            function todoApp() {
                return {
                    todos: [],
                    newTask: "",
                    loading: false,
                    error: "",

                    init() {
                        this.loadTodos();
                    },

                    async request(query, variables = {}) {
                        const res = await fetch("/graphql", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ query, variables }),
                        });
                        const { data, errors } = await res.json();
                        if (errors) throw new Error(errors[0].message);
                        return data;
                    },

                    showError(msg) {
                        this.error = `Error: ${msg}`;
                        setTimeout(() => (this.error = ""), 5000);
                    },

                    async loadTodos() {
                        this.loading = true;
                        try {
                            const data = await this.request(
                                `{ todos { id task } }`,
                            );
                            this.todos = data.todos;
                        } catch (e) {
                            this.showError(e.message);
                        }
                        this.loading = false;
                    },

                    async addTodo() {
                        if (!this.newTask.trim()) return;
                        this.loading = true;
                        try {
                            const data = await this.request(
                                `mutation($task: String!) { addTodo(task: $task) { id task } }`,
                                { task: this.newTask.trim() },
                            );
                            this.todos.push(data.addTodo);
                            this.newTask = "";
                        } catch (e) {
                            this.showError(e.message);
                        }
                        this.loading = false;
                    },

                    async deleteTodo(id) {
                        this.loading = true;
                        try {
                            await this.request(
                                `mutation { deleteTodo(id: ${id}) }`,
                            );
                            this.todos = this.todos.filter((t) => t.id !== id);
                        } catch (e) {
                            this.showError(e.message);
                        }
                        this.loading = false;
                    },
                };
            }
        </script>
    </body>
</html>
